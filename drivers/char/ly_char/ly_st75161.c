/*
 * ly_st75161.c -- support st75161
 *
 *  Author			zhangyunduan
 *  Email   		zhangyunduan@linyang.com.cn
 *  Create time 	2024-10-15
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 */
#include <linux/miscdevice.h>
#include <linux/delay.h>
#include <asm/irq.h>
#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/init.h>
#include <linux/mm.h>
#include <linux/fs.h>
#include <linux/types.h>
#include <linux/moduleparam.h>
#include <linux/slab.h>
#include <linux/errno.h>
#include <linux/ioctl.h>
#include <linux/cdev.h>
#include <linux/string.h>
#include <linux/list.h>
#include <linux/pci.h>
#include <linux/gpio.h>
#include <asm/uaccess.h>
#include <asm/atomic.h>
#include <asm/unistd.h>

#include <linux/version.h>
#include <linux/irq.h>
#include <linux/interrupt.h>
#include <linux/completion.h>
#include <linux/of_platform.h>
#include <linux/of_gpio.h>
#include <linux/of.h>
#include <linux/of_address.h>
#include <linux/of_device.h>
#include <linux/platform_device.h>
#include <linux/io.h>
#include <linux/err.h>
#include <linux/device.h>
#include <linux/vmalloc.h>
#include <linux/uaccess.h>
#include <asm/io.h>

#define DEVICE_NAME "fb0"

// #define __DEBUG__1

#define MAX_ROW_SIZE    160
#define MAX_COL_SIZE    160
#define LCD_BUFFER_SIZE (((MAX_ROW_SIZE) * (MAX_COL_SIZE)) >> 3)

#define LCD_PAGE_SIZE 20
#define LCD_COL_SIZE  160

#define LCD_VOP_INC 0x1
#define LCD_VOP_DEC 0
#define LCD_VOP_MIN 270
#define LCD_VOP_MAX 330

#define LCD_WRITE_BLOCK 0x03
#define LCD_REFRESH     0x56

// #define COMPATIBLE_ST75161_AHEAD

static unsigned int LastVop = 0;
static unsigned char LastStatus = 0;

static struct ly_st75161_dev *ly_st75161;

static unsigned char LcdData[20 * 160];

/* 定义魔数 */
#define LCD_CTL_MAGIC 'L'

/* 定义命令 */
#define LCD_RESET_CTR     _IOW(LCD_CTL_MAGIC, 1, int) //  复位控制  2  LH ; 1 H ; 0 L  其他无效
#define LCD_BACKLIGHT_CTR _IOW(LCD_CTL_MAGIC, 2, int) //  背光控制
#define LCD_SET_VOP_CTR   _IOW(LCD_CTL_MAGIC, 3, int)

struct ly_st75161_dev {
    struct gpio_desc *SCLK_gpios;
    struct gpio_desc *MOSI_gpios;
    struct gpio_desc *A0_gpios;
    struct gpio_desc *CSB_gpios;
    struct gpio_desc *RSTB_gpios;
    struct gpio_desc *BL_gpios;
	struct mutex lock;
};

#define ST75161_NOP         0x25
#define ST75161_READ_STATUS 0xfe

#define IO_DELAY_TIME 1

#define LCD_Com 160
#define LCD_Seg 160

static struct ly_st75161_dev *ly_st75161;

static const unsigned char logo_sms[LCD_PAGE_SIZE * LCD_COL_SIZE] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0,
    0xe0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xe0, 0xf0, 0xf0, 0xf8, 0xfc,
    0xfc, 0xfe, 0xfe, 0xfe, 0xff, 0x7f, 0x7f, 0x3f, 0x1f, 0x1f, 0x1f, 0x1f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f,
    0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x1f, 0x1f, 0x1f, 0x1e, 0x1e, 0x7e, 0x7c, 0x7c, 0x7c, 0xf8,
    0xf8, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xf0, 0xf0, 0xfc, 0xff, 0xff, 0xff, 0x7f, 0x3f, 0x0f, 0x8f, 0x87,
    0xe3, 0xe1, 0xe1, 0xf0, 0xf0, 0xf8, 0xf8, 0xf8, 0xf8, 0xfc, 0xfc, 0xfc, 0xfc, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe,
    0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xf8, 0xf8, 0xf8, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0,
    0x80, 0x80, 0x01, 0x01, 0x03, 0x03, 0x07, 0x07, 0x0e, 0x0e, 0x1c, 0x38, 0x70, 0x70, 0xe0, 0xc0, 0x80, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xf0,
    0x0c, 0x01, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xf7, 0xf3, 0xfd, 0xfc, 0xfe, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0x7f, 0x3f, 0x1f, 0x1f, 0x0f, 0x0f, 0x07, 0x07, 0x07, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x03, 0x03, 0x03, 0x03, 0x02, 0x06, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x04, 0x08,
    0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xfe, 0x1f, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x3f, 0x0f, 0x07, 0x03,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x80, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0f, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xe0,
    0x00, 0x00, 0x00, 0x00, 0x03, 0x3f, 0xff, 0xff, 0xff, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xc0, 0xc0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x1f, 0xff,
    0xfc, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x7f, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x1f, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfc, 0xf8, 0xf0, 0xc0, 0x80,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
    0x0f, 0x7f, 0xfe, 0xf0, 0xc0, 0x80, 0x00, 0x00, 0x07, 0x3f, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x0f, 0x1f, 0x1f, 0x3f, 0x3f, 0x7f, 0x7f, 0x7f, 0x7f, 0x3f, 0x3f,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x03, 0x0f, 0x7f, 0xff, 0xfc, 0xf0, 0xc0, 0x00, 0x00, 0x07, 0x1e, 0x3c, 0xf0, 0x80, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x10, 0x60, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0f, 0x3f, 0xff, 0xfc, 0xf0, 0xc0, 0x80, 0x00, 0x03, 0x0e, 0x18, 0x60, 0x80,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x06, 0x18, 0x60, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0f, 0x3f, 0x3f, 0xff, 0xfc, 0xf0, 0xe0, 0x80, 0x00,
    0x03, 0x0c, 0x08, 0x30, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x1e, 0xf8, 0xc0, 0x80, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x07, 0x1f, 0x3f, 0xff,
    0xfc, 0xf8, 0xf0, 0xe0, 0xc0, 0x01, 0x02, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x7f, 0xfc, 0xf0, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x07, 0x07, 0x1f, 0x3f, 0x7f, 0xfe, 0xf8, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff,
    0xf8, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x0f, 0x1f, 0x3f, 0x7f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc0, 0xc0,
    0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff,
    0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x0f, 0x1f, 0x1f, 0x3f,
    0x7f, 0xff, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xf8, 0xff, 0xff,
    0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x01, 0x07, 0x0f, 0x1f, 0x1f, 0x3f, 0x7f, 0x7f, 0xff, 0xfe, 0xfc, 0xf8, 0xf8, 0xf0, 0xf0, 0xe0, 0xc0,
    0xc0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xe0, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x0f, 0x0f, 0x1f, 0x1f, 0x3f,
    0x3f, 0x7f, 0xff, 0xff, 0xff, 0xfe, 0xfe, 0xfc, 0xfc, 0xf8, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0,
    0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
    0x80, 0x80, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0, 0xf0, 0xf8, 0xfc, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f,
    0x0f, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x03, 0x07, 0x0f, 0x0f, 0x1f, 0x1f, 0x1f, 0x3f, 0x3f, 0x7f, 0x7f, 0x7f, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x7f, 0x3f, 0x1f, 0x1f, 0x0f, 0x07, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

static inline void delay_databus(void)
{
    volatile int i;
    for (i = 0; i < IO_DELAY_TIME; i++)
        ;
}

static inline unsigned char spi_read_databus(void)
{
    unsigned char ch = 0x00;
    int i;

    gpiod_direction_input(ly_st75161->MOSI_gpios);

    for (i = 0; i < 8; i++) {
        gpiod_set_value(ly_st75161->SCLK_gpios, 0);
        delay_databus();
        ch <<= 1;
        gpiod_set_value(ly_st75161->SCLK_gpios, 1);
        delay_databus();
        if (gpiod_get_value(ly_st75161->MOSI_gpios)) {
            ch++;
        }
    }

    gpiod_direction_output(ly_st75161->MOSI_gpios, 1);

    return ch;
}

static inline void spi_set_databus(unsigned char ch)
{
    gpiod_set_value(ly_st75161->SCLK_gpios, 0);
    delay_databus();
    gpiod_set_value(ly_st75161->MOSI_gpios, ch & 0x80);
    delay_databus();
    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();

    gpiod_set_value(ly_st75161->SCLK_gpios, 0);
    delay_databus();
    gpiod_set_value(ly_st75161->MOSI_gpios, ch & 0x40);
    delay_databus();
    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();

    gpiod_set_value(ly_st75161->SCLK_gpios, 0);
    delay_databus();
    gpiod_set_value(ly_st75161->MOSI_gpios, ch & 0x20);
    delay_databus();
    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();

    gpiod_set_value(ly_st75161->SCLK_gpios, 0);
    delay_databus();
    gpiod_set_value(ly_st75161->MOSI_gpios, ch & 0x10);
    delay_databus();
    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();

    gpiod_set_value(ly_st75161->SCLK_gpios, 0);
    delay_databus();
    gpiod_set_value(ly_st75161->MOSI_gpios, ch & 0x08);
    delay_databus();
    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();

    gpiod_set_value(ly_st75161->SCLK_gpios, 0);
    delay_databus();
    gpiod_set_value(ly_st75161->MOSI_gpios, ch & 0x04);
    delay_databus();
    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();

    gpiod_set_value(ly_st75161->SCLK_gpios, 0);
    delay_databus();
    gpiod_set_value(ly_st75161->MOSI_gpios, ch & 0x02);
    delay_databus();
    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();

    gpiod_set_value(ly_st75161->SCLK_gpios, 0);
    delay_databus();
    gpiod_set_value(ly_st75161->MOSI_gpios, ch & 0x01);
    delay_databus();
    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();
}

static void write_cmd(unsigned int ch)
{
    gpiod_set_value(ly_st75161->A0_gpios, 0);
    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();

    spi_set_databus(ch);

    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();
}

static void write_dat(unsigned int ch)
{
    gpiod_set_value(ly_st75161->A0_gpios, 1);
    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();

    spi_set_databus(ch);

    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();
}

static unsigned char ST75161_ReadStatus(void)
{
    unsigned char ret;

    gpiod_set_value(ly_st75161->CSB_gpios, 0);
    write_cmd(ST75161_NOP);

    // write_cmd(READ_STATUS);
    gpiod_set_value(ly_st75161->A0_gpios, 0);
    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();

    spi_set_databus(ST75161_READ_STATUS);

    gpiod_set_value(ly_st75161->SCLK_gpios, 1);
    delay_databus();

    ret = spi_read_databus();

    write_cmd(ST75161_NOP);

    gpiod_set_value(ly_st75161->CSB_gpios, 1);

    return ret;
}

/********************************************************/
//  XS  Column 开始位置         X_Len  Column 长度
//  YS  Row 开始位置            Y_Len  Row 长度     YS 0- 19

/********************************************************/

static int ST75161_SetArea(unsigned char X_S, unsigned char X_E,
                           unsigned char Y_S, unsigned char Y_E)
{
    write_cmd(0x30); // Extension Command 1

    write_cmd(0x75); // Row Address Setting
    write_dat(Y_S);  // Starting page address
    write_dat(Y_E);  // Ending page address

    write_cmd(0x15); // Column Address Setting
    write_dat(X_S);  // Starting column address
    write_dat(X_E);  // Ending column address

    write_cmd(0x5c); // Write data
    return 0;
}

static int st75161_setpin(void)
{
    int ret;

    ret = gpiod_direction_output(ly_st75161->SCLK_gpios, 1);
    ret += gpiod_direction_output(ly_st75161->MOSI_gpios, 1);
    ret += gpiod_direction_output(ly_st75161->A0_gpios, 1);
    ret += gpiod_direction_output(ly_st75161->CSB_gpios, 1);
    ret += gpiod_direction_output(ly_st75161->RSTB_gpios, 1);
    ret += gpiod_direction_output(ly_st75161->BL_gpios, 1);

    return ret;
}

static int st75161_reset(void)
{
    gpiod_set_value(ly_st75161->RSTB_gpios, 0);
    mdelay(5);
    gpiod_set_value(ly_st75161->RSTB_gpios, 1);
    mdelay(4);

    return 0;
}

void ST75161_PowerOn(void)
{
    int i = 0;

    gpiod_set_value(ly_st75161->CSB_gpios, 0);
    delay_databus();

    ST75161_SetArea(0, 159, 0, 19);
    for (i = 0; i < LCD_PAGE_SIZE * LCD_COL_SIZE; i++) {
        write_dat(logo_sms[i]);
    }

    gpiod_set_value(ly_st75161->CSB_gpios, 1);
}

static void ST75161_SetVop(unsigned int vop)
{
    unsigned char vop_low, vop_high;
    unsigned int vop_p = vop;

    if (vop < LCD_VOP_MIN)
        vop_p = LCD_VOP_MIN;

    else if (vop > LCD_VOP_MAX)
        vop_p = LCD_VOP_MAX;

    vop_low = vop_p & 0x3f;
    vop_high = (vop_p & 0x1c0) >> 6;

    write_cmd(0x81); // set Vop

    write_dat(vop_low);  // Vop[5:0]  14.5V    1/12  0x30
    write_dat(vop_high); // Vop[8:6]

    LastVop = vop_p;
}

static void display_block(unsigned char *bmparea, unsigned char s_page,
                          unsigned char e_page, unsigned char s_col, unsigned char e_col)
{
    unsigned int i, j;
    unsigned int page_size = e_page - s_page + 1;
    unsigned int col_size = e_col - s_col + 1;

    gpiod_set_value(ly_st75161->CSB_gpios, 0);
    delay_databus();
    ST75161_SetArea(s_col, e_col, s_page, e_page);
    delay_databus();
    gpiod_set_value(ly_st75161->CSB_gpios, 1);
    delay_databus();
    gpiod_set_value(ly_st75161->CSB_gpios, 0);
    delay_databus();
    for (i = 0; i < page_size; i++) {
        for (j = 0; j < col_size; j++) {
            write_dat(bmparea[i * col_size + j]);
        }
    }
    delay_databus();
    gpiod_set_value(ly_st75161->CSB_gpios, 1);
}

static void display_bmp(unsigned char *bmparea)
{
    display_block(bmparea, 0, LCD_PAGE_SIZE - 1, 0, LCD_COL_SIZE - 1);
}

static int st75161_regInit(bool reset)
{
    if (reset) {
        st75161_reset();
    }

    gpiod_set_value(ly_st75161->CSB_gpios, 0);
    delay_databus();

    write_cmd(0x30); // Extension Command 1
    write_cmd(0x94); // Sleep out
    write_cmd(0xD1); // Turns on the internal oscillation circuit.
    if (reset) {
        write_cmd(0xAE); // display off
        udelay(20);
    }

    write_cmd(0xA6); // Normal Display
    write_cmd(0x94); // Sleep out
    write_cmd(0xCA); // Displsy Control
    write_dat(0x00); // CL Dividing Ratio:Not Divide
    write_dat(0x9F); // Duty Set:160 Duty
    write_dat(0x25);

    write_cmd(0xBC); // Data Scan Direction
    write_dat(0x00); // MV=0,MX=0

    write_cmd(0xAB); // Start line address
    write_dat(0x00);

    write_cmd(0x20); // Power Control
    write_dat(0x0B); // VB, VR,VF All ON

    if (LastVop) {
        ST75161_SetVop(LastVop);
    } else {
        write_cmd(0x81); // set Vop
        write_dat(0x25); // Vop[5:0]  14.5V    1/12  0x30
        write_dat(0x04); // Vop[8:6]
    }

    write_cmd(0x0C); // LSB on top      20190924
    write_cmd(0xF0); // Display Mode     20190924
    write_dat(0x10); // Mono Mode        20190924
    write_cmd(0x76); // ICON=0 ; Disable ICON RAM.

    write_cmd(0x31); // Extension Command 2
    write_cmd(0x32); // Analog Circuit Set
    write_dat(0x00);
    write_dat(0x01); // Booster Efficiency =6KHz
    write_dat(0x03); // 1/11 Bias

    write_cmd(0x51); // Booster Level Set
    write_dat(0xFB); // 10 Times

    write_cmd(0x40); // Internal Power Supply
    write_cmd(0xF0); // Frame Rate
    write_dat(0x01); // FA=10Hz
    write_dat(0x03); // FB=34.5Hz
    write_dat(0x06); // FC = 46Hz
    write_dat(0x0d); // FD = 73Hz

    write_cmd(0xF2); // Temperature Range
    write_dat(0x03); // TA=-37
    write_dat(0x23); // TB=-5
    write_dat(0x40); // TC=24

    write_cmd(0xF4); // Temperature Gradient Compensation
    write_dat(0x43); // MT1=4,MT0=3
    write_dat(0x11); // MT3=1,MT2=1
    write_dat(0x11); // MT5=1,MT4=1
    write_dat(0x11); // MT7=1,MT6=1
    write_dat(0x00); // MT9=0,MT8=0
    write_dat(0x06); // MTB=0,MTA=6
    write_dat(0xBC); // MTD=11,MTC=12
    write_dat(0xff); // MTF=15,MTE=15

    write_cmd(0x30); // Extension command 1

    write_cmd(0xAF); // Display ON

    if (reset) {
        display_bmp(LcdData);
    }

    gpiod_set_value(ly_st75161->CSB_gpios, 1);

    return 0;
}

static int initialization_st75161(void)
{
    int ret;

    ret = st75161_setpin();
    if (ret < 0) {
        return ret;
    }

    memset(LcdData, 0, sizeof(LcdData));

#if 0
    ret = st75161_regInit(true);
    if (ret < 0) {
        return ret;
    }
#endif

    LastStatus = ST75161_ReadStatus();

#if 0
    ST75161_PowerOn();
#endif

    return 0;
}

static int st75161_open(struct inode *inode, struct file *file)
{
    return 0;
}

static int st75161_close(struct inode *inode, struct file *file)
{
    return 0;
}

static ssize_t st75161_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos)
{
    return 0;
}

static ssize_t st75161_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos)
{
    unsigned char wcmd[5];
    unsigned char s_page = 0x00, i;
    unsigned char e_page = 0x00;
    unsigned char s_col = 0x00;
    unsigned char e_col = 0x00;
    // unsigned char  PageCnt; // ColCnt
    uint32_t real_data_len;

    mutex_lock(&ly_st75161->lock);

    real_data_len = count - 5;

    if (count < 5 || real_data_len > LCD_BUFFER_SIZE) {
        pr_err("st75161_write len error:%ld\n", count);
        mutex_unlock(&ly_st75161->lock);
        return -EINVAL;
    }

    if (copy_from_user(wcmd, buf, 5)) {
        pr_err("st75161_write copy_from_user cmd error\n");
        mutex_unlock(&ly_st75161->lock);
        return -EINVAL;
    }

    switch (wcmd[0]) {
    case LCD_WRITE_BLOCK:
        s_page = wcmd[1];
        e_page = wcmd[2];
        s_col = wcmd[3];
        e_col = wcmd[4];

        if (s_page > e_page || s_col > e_col ||
            (e_page - s_page) >= LCD_PAGE_SIZE ||
            (e_col - s_col) >= LCD_COL_SIZE) {
            pr_err("st75161_write start end data error: %d-%d %d-%d\n",
                   s_page, e_page, s_col, e_col);
            mutex_unlock(&ly_st75161->lock);
            return -EINVAL;
        }

        if (copy_from_user(LcdData, buf + 5, real_data_len)) {
            pr_err("st75161_write copy_from_user data error\n");
            mutex_unlock(&ly_st75161->lock);
            return -EINVAL;
        }

        display_block(LcdData, s_page, e_page, s_col, e_col);
        break;
    case LCD_REFRESH:
        i = ST75161_ReadStatus() & 0xef;
        LastStatus &= 0xef;

        if ((LastStatus != i) || (0 == i) || (0xff == i)) {
            st75161_reset();
        }

        st75161_regInit(false);

        if ((LastStatus != i) || (0 == i) || (0xff == i)) {
            LastStatus = ST75161_ReadStatus();
        }
        break;
    default:
        pr_err("st75161_write cmd[0] error\n");
        mutex_unlock(&ly_st75161->lock);
        return -1;
    }

    mutex_unlock(&ly_st75161->lock);
    return 0;
}

static long st75161_ioctl(struct file *file, unsigned int cmd, unsigned long arg)
{
    int ret = 0;
    unsigned int data;

    switch (cmd) {

    case LCD_RESET_CTR:
        st75161_reset();
        break;

    case LCD_BACKLIGHT_CTR:
        data = arg;

        if (0 == data)
            gpiod_set_value(ly_st75161->BL_gpios, 0);
        else
            gpiod_set_value(ly_st75161->BL_gpios, 1);

        break;

    case LCD_SET_VOP_CTR:
        data = arg;
        ST75161_SetVop(data);
        break;
    }

    return ret;
}

static struct file_operations st75161_fops = {
    .owner = THIS_MODULE,
    .open = st75161_open,
    .release = st75161_close,
    .read = st75161_read,
    .write = st75161_write,
    .unlocked_ioctl = st75161_ioctl,
};

static struct miscdevice miscst75161 = {
    .minor = MISC_DYNAMIC_MINOR,
    .name = DEVICE_NAME,
    .fops = &st75161_fops,
};

static int st75161_probe(struct platform_device *pdev)
{
    int ret;

    ly_st75161 = devm_kzalloc(&pdev->dev, sizeof(struct ly_st75161_dev), GFP_KERNEL);
    if (NULL == ly_st75161) {
        pr_err("st75161: no memory to zalloc\n");
        ret = -ENOMEM;
    }

	ly_st75161->A0_gpios = devm_gpiod_get(&pdev->dev, "lcd-A0", GPIOD_OUT_HIGH);
	if (IS_ERR(ly_st75161->A0_gpios)) {
		pr_err("st75161: cannot get lcd-A0 gpio\n");
		return PTR_ERR(ly_st75161->A0_gpios);
	}

	ly_st75161->SCLK_gpios = devm_gpiod_get(&pdev->dev, "lcd-SCLK", GPIOD_OUT_HIGH);
	if (IS_ERR(ly_st75161->SCLK_gpios)) {
		pr_err("st75161: cannot get lcd-SCLK gpio\n");
		return PTR_ERR(ly_st75161->SCLK_gpios);
	}

	ly_st75161->MOSI_gpios = devm_gpiod_get(&pdev->dev, "lcd-MOSI", GPIOD_OUT_HIGH);
	if (IS_ERR(ly_st75161->MOSI_gpios)) {
		pr_err("st75161: cannot get lcd-MOSI gpio\n");
		return PTR_ERR(ly_st75161->MOSI_gpios);
	}

	ly_st75161->CSB_gpios = devm_gpiod_get(&pdev->dev, "lcd-CSB", GPIOD_OUT_HIGH);
	if (IS_ERR(ly_st75161->CSB_gpios)) {
		pr_err("st75161: cannot get lcd-CSB gpio\n");
		return PTR_ERR(ly_st75161->CSB_gpios);
	}

	ly_st75161->RSTB_gpios = devm_gpiod_get(&pdev->dev, "lcd-RSTB", GPIOD_OUT_HIGH);
	if (IS_ERR(ly_st75161->RSTB_gpios)) {
		pr_err("st75161: cannot get lcd-RSTB gpio\n");
		return PTR_ERR(ly_st75161->RSTB_gpios);
	}

	ly_st75161->BL_gpios = devm_gpiod_get(&pdev->dev, "lcd-BL", GPIOD_OUT_LOW);
	if (IS_ERR(ly_st75161->BL_gpios)) {
		pr_err("st75161: cannot get lcd-BL gpio\n");
		return PTR_ERR(ly_st75161->BL_gpios);
	}

    ret = initialization_st75161();
    if (ret < 0) {
        pr_err("st75161: initialization st75161 error!\n");
        return ret;
    }

    ret = misc_register(&miscst75161);
    if (ret < 0) {
        pr_err("st75161: misc register error!\n");
        return ret;
    }
    pr_info("st75161: misc register successed.\n");

    mutex_init(&ly_st75161->lock);

    return ret;
}

static int st75161_remove(struct platform_device *pdev)
{
    mutex_lock(&ly_st75161->lock);
    misc_deregister(&miscst75161);
    mutex_unlock(&ly_st75161->lock);

    return 0;
}

static const struct of_device_id ly_st75161_dt_ids[] = {
    {.compatible = "ly-st75161"},
    {/* sentinel */},
};

MODULE_DEVICE_TABLE(of, ly_st75161_dt_ids);

static struct platform_driver ly_st75161_driver = {
    .probe = st75161_probe,
    .remove = st75161_remove,
    .driver = {
        .name = "ly_st75161",
        .of_match_table = of_match_ptr(ly_st75161_dt_ids),
    },
};

static int __init st75161_init(void)
{
    return platform_driver_register(&ly_st75161_driver);
}

static void __exit st75161_exit(void)
{
    platform_driver_unregister(&ly_st75161_driver);
}

module_init(st75161_init);

module_exit(st75161_exit);

MODULE_DESCRIPTION("Driver for st75161");
MODULE_AUTHOR("zhangyunduan@linyang.com.cn");
MODULE_LICENSE("GPL");
MODULE_ALIAS("st75161");
